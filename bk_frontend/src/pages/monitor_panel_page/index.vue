<template>
  <div class="monitor_panel">
    <el-row :gutter="20" type="flex" class="monitor_panel-top" justify="space-between">
      <el-col :span="12">
        <div class="monitor_panel-top-word">任务统计</div>
      </el-col>
      <el-col :span="12">
        <div class="monitor_panel-top-word">性能状态</div>
      </el-col>
    </el-row>
    <el-row :gutter="20" type="flex" class="monitor_panel-middle" justify="space-between">
      <el-col :span="12">
        <div class="monitor_panel-row-middle chart-pic" id="task_pic"></div>
      </el-col>
      <el-col :span="12">
        <div class="monitor_panel-row-middle chart-pic">
          <div class="chart-pic-select">
            <span>服务器：</span>
            <el-select
            size="mini"
            v-model="server"
            @change="serverChange"
            :placeholder="defaultServer">
              <el-option
                v-for="(item, index) in optionsServer"
                :key="index"
                :label="item.ip"
                :value="item.id">
              </el-option>
            </el-select>
          </div>
          <div class="chart-pic-right" id="cpu_pic"></div>
        </div>
      </el-col>
    </el-row>
    <el-row type="flex" class="monitor_panel-end">
      <el-col :span="24">
        <div class="monitor_panel-end-pic" id="server_pic"></div>
      </el-col>
    </el-row>
  </div>
</template>

<script>
export default {
  data() {
    return {
      server: '',
      serverId: 1,
      defaultServer: '',
      optionsServer: [],
    }
  },
  mounted() {
    this.initTaskChart()
    this.getServerData()
    this.initCpuChart()
    this.initBizServerChart()
    // this.setTime()
  },
  methods: {
    // 初始化任务饼图
    async initTaskChart() {
      // 基于准备好的dom，开始初始化任务饼图
      let taskChart = this.$echarts.init(document.getElementById('task_pic'));
      let option = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b} : {c} ({d}%)'
        },
        legend: {
          type: 'scroll',
          orient: 'vertical',
          right: 10,
          top: 20,
          bottom: 20,
        },
      }
      taskChart.setOption(option);
      let dataName = {
        waitting: '等待中',
        running: '运行中',
        success: '已成功',
        fail: '已失败'
      }
      taskChart.showLoading()
      await this.$store.dispatch('pie/getTaskState').then(res => {
        if (res.result) {
          let data = [];
          Object.keys(res.data).forEach((i) => {
            Object.keys(dataName).forEach(j => {
              if (i == j) {
                data.push({
                  name: dataName[j],
                  value: res.data[i]
                })
              }
            })
          })
          taskChart.setOption(
            {
              series: [
                {
                  name: '任务状态',
                  type: 'pie',
                  color: ['#fa541c', '#fadb14', '#a0d911', '#1890ff'],
                  radius: ['30%', '70%'],
                  data: data,
                  itemStyle: {
                    emphasis: {
                      shadowBlur: 10,
                      shadowOffsetX: 0,
                      shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                  }
                }
              ]
            }
          );
        }
      })
      taskChart.hideLoading()
      // 浏览器放大或缩小时无需刷新图表自动随页面的大小而变化
      window.addEventListener('resize', taskChart.resize)
    },
    // 获取服务器数据
    getServerData() {
      this.$store.dispatch('pie/getServerSelect').then(res => {
        if (res.result) {
          this.optionsServer = res.data
          this.defaultServer = this.optionsServer[1].ip
        }
      })
    },
    // 下拉框数据发生改变时触发
    serverChange(val) {
      this.serverId = val
      this.initCpuChart(val)
    },
    // 初始化cpu折线图
    async initCpuChart() {
      let cpuChart = this.$echarts.init(document.getElementById('cpu_pic'))
      let params = {
        id: this.serverId
      }
      let data = []
      let cpuData = []
      let memoryData = []
      cpuChart.showLoading({ text: '正在努力加载数据...' })
      await this.$store.dispatch('pie/getServerPerformance', params).then(res => {
        if (res.result) {
          data = res.data.map(item => item.product)
          cpuData = res.data.map(item => item.cpu)
          memoryData = res.data.map(item => item.mem)
          let option = {
            title: {
              // text: 'Cpu、内存使用率'
            },
            tooltip: {
              trigger: 'axis'
            },
            legend: {
              data: ['CPU', '内存']
            },
            xAxis: {
              type: 'category',
              data: data
            },
            yAxis: {
              type: 'value',
              min: 0
            },
            series: [
              {
                name: 'CPU',
                color: '#fa541c',
                data: cpuData,
                type: 'line',
                smooth: true
              },
              {
                name: '内存',
                data: memoryData,
                color: '#a0d911',
                type: 'line',
                smooth: true
              },
            ]
          }
          cpuChart.setOption(option)
        }
      })
      cpuChart.hideLoading()
      // 浏览器放大或缩小时无需刷新图表自动随页面的大小而变化
      window.addEventListener('resize', cpuChart.resize)
      // window.onresize = function() {
      //   cpuChart.resize()
      // }
    },
    // 定时器
    setTime() {
      let app = {};
      app.timeTicket = setInterval(() => { //定时刷新图表
        this.initCpuChart();
      }, 300000);
    },
    // 初始化柱状图
    async initBizServerChart() {
      let bizServerChart = this.$echarts.init(document.getElementById('server_pic'))
      await this.$store.dispatch('pie/getBizServer').then(res => {
        if (res.result) {
          let dataSource = [['product', 'windows', 'linux']]
          Object.keys(res.data).forEach((i) => {
            dataSource.push([res.data[i].product, res.data[i].windows, res.data[i].linux])
          })
          let option = {
            legend: {},
            tooltip: {},
            dataset: {
              source: dataSource
            },
            xAxis: {type: 'category'},
            yAxis: {
              type: 'value',
              max: function(value) {
                return value.max + 10
              }
            },
            series: [
              {type: 'bar', color: '#5793f3'},
              {type: 'bar', color: '#d14a61'}
            ]
          };
          bizServerChart.setOption(option)
        }
      })
      // 浏览器放大或缩小时无需刷新图表自动随页面的大小而变化
      window.addEventListener('resize', bizServerChart.resize)
    },
  }
}
</script>
